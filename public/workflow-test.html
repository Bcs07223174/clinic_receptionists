<!DOCTYPE html>
<html>
<head>
    <title>Complete Workflow Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .output { background: #f5f5f5; padding: 10px; margin: 10px 0; white-space: pre-wrap; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; background: #007cba; color: white; border: none; }
        .error { color: red; }
        .success { color: green; }
        .status { font-weight: bold; }
    </style>
</head>
<body>
    <h1>Complete Workflow Test</h1>
    
    <div class="step">
        <h3>Step 1: Login and Store Data</h3>
        <button onclick="performLogin()">Login</button>
        <div id="loginStatus" class="status"></div>
        <div id="loginOutput" class="output"></div>
    </div>
    
    <div class="step">
        <h3>Step 2: Check LocalStorage (Frontend Logic)</h3>
        <button onclick="checkFrontendLogic()">Check Frontend Logic</button>
        <div id="frontendStatus" class="status"></div>
        <div id="frontendOutput" class="output"></div>
    </div>
    
    <div class="step">
        <h3>Step 3: Test Appointments API</h3>
        <button onclick="testAppointmentsAPI()">Test Appointments</button>
        <div id="apiStatus" class="status"></div>
        <div id="apiOutput" class="output"></div>
    </div>
    
    <div class="step">
        <h3>Step 4: Full Simulation</h3>
        <button onclick="runFullTest()">Run Full Test</button>
        <div id="fullStatus" class="status"></div>
        <div id="fullOutput" class="output"></div>
    </div>

    <script>
        async function performLogin() {
            const loginStatus = document.getElementById('loginStatus');
            const loginOutput = document.getElementById('loginOutput');
            
            loginStatus.textContent = 'Logging in...';
            loginStatus.className = 'status';
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'adminareceptionist@medicare.com',
                        password: 'Admin#123'
                    }),
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Store exactly like the real app
                    localStorage.setItem("receptionist", JSON.stringify(data.receptionist));
                    localStorage.setItem("doctors", JSON.stringify(data.doctors));
                    
                    loginStatus.textContent = 'Login successful!';
                    loginStatus.className = 'status success';
                    loginOutput.textContent = JSON.stringify(data, null, 2);
                } else {
                    loginStatus.textContent = 'Login failed!';
                    loginStatus.className = 'status error';
                    loginOutput.textContent = data.error;
                }
            } catch (error) {
                loginStatus.textContent = 'Login error!';
                loginStatus.className = 'status error';
                loginOutput.textContent = error.message;
            }
        }
        
        function checkFrontendLogic() {
            const frontendStatus = document.getElementById('frontendStatus');
            const frontendOutput = document.getElementById('frontendOutput');
            
            // Simulate the exact logic from appointments-tab.tsx
            let user = localStorage.getItem('user');
            let receptionist = localStorage.getItem('receptionist');
            
            let output = '';
            output += 'Raw user from localStorage: ' + user + '\\n';
            output += 'Raw receptionist from localStorage: ' + receptionist + '\\n';
            
            let parsedUser = null;
            
            if (receptionist) {
                parsedUser = JSON.parse(receptionist);
                output += 'Using receptionist data: ' + JSON.stringify(parsedUser, null, 2) + '\\n';
            } else if (user) {
                parsedUser = JSON.parse(user);
                output += 'Using user data: ' + JSON.stringify(parsedUser, null, 2) + '\\n';
            } else {
                frontendStatus.textContent = 'No user data found!';
                frontendStatus.className = 'status error';
                frontendOutput.textContent = output;
                return;
            }
            
            const doctorIds = parsedUser.linkedDoctorIds || parsedUser.linked_doctor_ids || [];
            output += 'Doctor IDs from user: ' + JSON.stringify(doctorIds) + '\\n';
            output += 'Available fields: ' + JSON.stringify(Object.keys(parsedUser)) + '\\n';
            
            if (doctorIds.length > 0) {
                frontendStatus.textContent = 'Frontend logic working!';
                frontendStatus.className = 'status success';
                output += 'Will use doctor ID: ' + doctorIds[0];
            } else {
                frontendStatus.textContent = 'No doctor IDs found!';
                frontendStatus.className = 'status error';
            }
            
            frontendOutput.textContent = output;
        }
        
        async function testAppointmentsAPI() {
            const apiStatus = document.getElementById('apiStatus');
            const apiOutput = document.getElementById('apiOutput');
            
            // Get doctor ID from localStorage
            const receptionist = localStorage.getItem('receptionist');
            if (!receptionist) {
                apiStatus.textContent = 'No receptionist data! Login first.';
                apiStatus.className = 'status error';
                return;
            }
            
            const parsedUser = JSON.parse(receptionist);
            const doctorIds = parsedUser.linkedDoctorIds || parsedUser.linked_doctor_ids || [];
            
            if (doctorIds.length === 0) {
                apiStatus.textContent = 'No doctor IDs found!';
                apiStatus.className = 'status error';
                return;
            }
            
            const doctorId = doctorIds[0];
            apiStatus.textContent = 'Testing API...';
            apiStatus.className = 'status';
            
            try {
                const response = await fetch(`/api/appointments?doctorId=${doctorId}`);
                const data = await response.json();
                
                if (response.ok) {
                    apiStatus.textContent = `API successful! Found ${data.appointments ? data.appointments.length : 0} appointments`;
                    apiStatus.className = 'status success';
                    apiOutput.textContent = JSON.stringify(data, null, 2);
                } else {
                    apiStatus.textContent = 'API failed!';
                    apiStatus.className = 'status error';
                    apiOutput.textContent = data.error;
                }
            } catch (error) {
                apiStatus.textContent = 'API error!';
                apiStatus.className = 'status error';
                apiOutput.textContent = error.message;
            }
        }
        
        async function runFullTest() {
            const fullStatus = document.getElementById('fullStatus');
            const fullOutput = document.getElementById('fullOutput');
            
            fullStatus.textContent = 'Running full test...';
            fullStatus.className = 'status';
            
            let output = '';
            
            try {
                // Step 1: Login
                output += '=== STEP 1: LOGIN ===\\n';
                const loginResponse = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'adminareceptionist@medicare.com',
                        password: 'Admin#123'
                    }),
                });
                
                if (!loginResponse.ok) {
                    throw new Error('Login failed');
                }
                
                const loginData = await loginResponse.json();
                localStorage.setItem("receptionist", JSON.stringify(loginData.receptionist));
                localStorage.setItem("doctors", JSON.stringify(loginData.doctors));
                
                output += 'Login successful\\n';
                output += 'Doctor IDs: ' + JSON.stringify(loginData.receptionist.linkedDoctorIds) + '\\n\\n';
                
                // Step 2: Fetch appointments
                output += '=== STEP 2: FETCH APPOINTMENTS ===\\n';
                const doctorId = loginData.receptionist.linkedDoctorIds[0];
                
                const appointmentsResponse = await fetch(`/api/appointments?doctorId=${doctorId}`);
                const appointmentsData = await appointmentsResponse.json();
                
                if (appointmentsResponse.ok) {
                    output += `Appointments fetched successfully: ${appointmentsData.appointments.length} found\\n`;
                    output += 'Sample appointment: ' + JSON.stringify(appointmentsData.appointments[0] || 'None', null, 2) + '\\n';
                    
                    fullStatus.textContent = `Full test successful! ${appointmentsData.appointments.length} appointments found`;
                    fullStatus.className = 'status success';
                } else {
                    throw new Error('Appointments fetch failed: ' + appointmentsData.error);
                }
                
            } catch (error) {
                output += 'ERROR: ' + error.message + '\\n';
                fullStatus.textContent = 'Full test failed!';
                fullStatus.className = 'status error';
            }
            
            fullOutput.textContent = output;
        }
        
        // Auto-run basic checks on load
        window.onload = function() {
            const receptionist = localStorage.getItem('receptionist');
            if (receptionist) {
                checkFrontendLogic();
            }
        };
    </script>
</body>
</html>