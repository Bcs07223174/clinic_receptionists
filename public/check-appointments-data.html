<!DOCTYPE html>
<html>
<head>
    <title>Appointments Data Check</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .output { background: #f5f5f5; padding: 10px; margin: 10px 0; white-space: pre-wrap; font-family: monospace; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; background: #007cba; color: white; border: none; }
        .error { color: red; }
        .success { color: green; }
        .status { font-weight: bold; }
        table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>Appointments Collection Data Check</h1>
    
    <div class="section">
        <h3>1. Comprehensive Data Analysis</h3>
        <button onclick="checkAppointmentsData()">Check Appointments Data</button>
        <div id="dataStatus" class="status"></div>
        <div id="dataOutput" class="output"></div>
    </div>
    
    <div class="section">
        <h3>2. Direct API Test (Current System)</h3>
        <button onclick="testCurrentAPI()">Test Current API</button>
        <div id="apiStatus" class="status"></div>
        <div id="apiOutput" class="output"></div>
    </div>
    
    <div class="section">
        <h3>3. Raw Collection Query</h3>
        <button onclick="queryRawCollection()">Query Raw Collection</button>
        <div id="rawStatus" class="status"></div>
        <div id="rawOutput" class="output"></div>
    </div>

    <script>
        async function checkAppointmentsData() {
            const status = document.getElementById('dataStatus');
            const output = document.getElementById('dataOutput');
            
            status.textContent = 'Fetching comprehensive data...';
            status.className = 'status';
            
            try {
                const response = await fetch('/api/test-appointments-data');
                const data = await response.json();
                
                if (response.ok) {
                    status.textContent = 'Data retrieved successfully!';
                    status.className = 'status success';
                    
                    let htmlOutput = '';
                    htmlOutput += `Total Appointments: ${data.totalAppointments}\\n\\n`;
                    
                    htmlOutput += 'Unique Doctor IDs in Appointments:\\n';
                    data.uniqueDoctorIds.forEach(id => {
                        htmlOutput += `- ${id} (type: ${typeof id})\\n`;
                    });
                    
                    htmlOutput += '\\nCurrent Receptionist:\\n';
                    htmlOutput += `Email: ${data.receptionist.email}\\n`;
                    htmlOutput += `Linked Doctor IDs: ${JSON.stringify(data.receptionist.linkedDoctorIds)}\\n`;
                    
                    if (data.linkedDoctorCheck) {
                        htmlOutput += '\\nLinked Doctor Check:\\n';
                        htmlOutput += `Doctor ID: ${data.linkedDoctorCheck.doctorId}\\n`;
                        htmlOutput += `Appointments by ObjectId: ${data.linkedDoctorCheck.appointmentsByObjectId}\\n`;
                        htmlOutput += `Appointments by String: ${data.linkedDoctorCheck.appointmentsByString}\\n`;
                    }
                    
                    htmlOutput += '\\nAppointments by Doctor:\\n';
                    data.appointmentsByDoctor.forEach(group => {
                        htmlOutput += `Doctor ${group._id}: ${group.count} appointments\\n`;
                    });
                    
                    htmlOutput += '\\nSample Appointments:\\n';
                    data.sampleAppointments.forEach((apt, index) => {
                        htmlOutput += `${index + 1}. ${apt.patientName} - ${apt.appointmentDate} (${apt.status})\\n`;
                        htmlOutput += `   Doctor ID: ${apt.doctorId} (${typeof apt.doctorId})\\n`;
                    });
                    
                    output.textContent = htmlOutput;
                } else {
                    status.textContent = 'Data fetch failed!';
                    status.className = 'status error';
                    output.textContent = data.error;
                }
            } catch (error) {
                status.textContent = 'Error fetching data!';
                status.className = 'status error';
                output.textContent = error.message;
            }
        }
        
        async function testCurrentAPI() {
            const status = document.getElementById('apiStatus');
            const output = document.getElementById('apiOutput');
            
            status.textContent = 'Testing current API...';
            status.className = 'status';
            
            try {
                // First get doctor ID from localStorage or use known ID
                const doctorId = '68c1b0a8290666380fd5fa35'; // Known working ID
                
                const response = await fetch(`/api/appointments?doctorId=${doctorId}`);
                const data = await response.json();
                
                if (response.ok) {
                    status.textContent = `API working! Found ${data.appointments.length} appointments`;
                    status.className = 'status success';
                    
                    let htmlOutput = `API Response for Doctor ID: ${doctorId}\\n\\n`;
                    htmlOutput += `Appointments Found: ${data.appointments.length}\\n\\n`;
                    
                    if (data.debugInfo) {
                        htmlOutput += 'Debug Info:\\n';
                        htmlOutput += `Total in Database: ${data.debugInfo.totalInDatabase}\\n`;
                        htmlOutput += `Searched by ObjectId: ${data.debugInfo.searchedByObjectId}\\n`;
                        htmlOutput += `Searched by String: ${data.debugInfo.searchedByString}\\n\\n`;
                    }
                    
                    htmlOutput += 'Appointments:\\n';
                    data.appointments.forEach((apt, index) => {
                        htmlOutput += `${index + 1}. ${apt.patientName}\\n`;
                        htmlOutput += `   Date: ${apt.appointmentDate}\\n`;
                        htmlOutput += `   Status: ${apt.status}\\n`;
                        htmlOutput += `   Reason: ${apt.reason}\\n\\n`;
                    });
                    
                    output.textContent = htmlOutput;
                } else {
                    status.textContent = 'API failed!';
                    status.className = 'status error';
                    output.textContent = data.error;
                }
            } catch (error) {
                status.textContent = 'API error!';
                status.className = 'status error';
                output.textContent = error.message;
            }
        }
        
        async function queryRawCollection() {
            const status = document.getElementById('rawStatus');
            const output = document.getElementById('rawOutput');
            
            // This would require a special API endpoint to query raw collection
            status.textContent = 'Raw collection query requires backend implementation';
            status.className = 'status';
            output.textContent = 'Use the "Check Appointments Data" button above for comprehensive collection analysis.';
        }
        
        // Auto-run the comprehensive check on page load
        window.onload = checkAppointmentsData;
    </script>
</body>
</html>